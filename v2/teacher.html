<!DOCTYPE html>
<html>
<head>
	<title>STEM Unicorn - Teacher Dashboard</title>
	<link rel = "stylesheet" href = "../bootstrap-5.0.1-dist/css/bootstrap.min.css" type = "text/css" />
	<link rel = "preconnect" href = "https://fonts.gstatic.com" />
	<link rel = "stylesheet" href = "https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,400;0,700;1,400;1,700&display=swap" />
	<link rel = "stylesheet" href = "https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" />
	<style>
		* {
			font-family: Lato, sans-serif;
		}
		html {
			height: 100vh;
		}
		body {
			background-image: radial-gradient(circle, #5441cc 30%, #0b0052);
			color: white;
			position: relative;
			overflow-x: hidden;
		}
		nav {
			background-color: #ffa600;
		}
		.btn-danger:hover {
			background-color: #bb2d3b !important;
		}
	</style>
</head>
<body>
	<nav class = "navbar navbar-expand-lg navbar-dark">
		<div class = "container-fluid">
			<span class = "navbar-brand mb-0 h1">STEM Unicorn</span>
			<span class = "navbar-text ms-auto">Welcome, James</span>
			<span class = "navbar-text ms-3"><button class = "btn btn-sm btn-outline-light">Log out</button></span>
		</div>
	</nav>
	<div class = "card mt-5 mx-auto w-50 text-dark text-center">
		<div class = "card-body">
			<p>You have not created a class yet.</p>
			<p class = "mb-0"><button class = "btn btn-primary" onclick = "createClass()">Create</button></p>
		</div>
	</div>
	<script src = "../jquery-3.6.0.min.js"></script>
	<script src = "../bootstrap-5.0.1-dist/js/bootstrap.bundle.min.js"></script>
	<script src = "https://www.gstatic.com/firebasejs/8.7.1/firebase.js"></script>
	<script>
		var firebaseConfig = {
		    apiKey: "AIzaSyCXHZy-JwPN7xg40bs42AXDRZ1yE0TE3bw",
		    authDomain: "stemunicorn.firebaseapp.com",
		    projectId: "stemunicorn",
		    storageBucket: "stemunicorn.appspot.com",
		    messagingSenderId: "797956205598",
		    appId: "1:797956205598:web:00753c21e03763eea5520f"
		};
 		firebase.initializeApp(firebaseConfig);
 		var db = firebase.firestore();
 		var code = Array.from(Array(6), () => Math.floor(Math.random() * 36).toString(36)).join('').toUpperCase();
 		var size = 0;
 		var colors = ["255, 0, 0", "255, 213, 0", "0, 255, 0", "0, 0, 255"];
 		var selection = 0;
 		function beginSelection() {
 			$(".card .btn-primary").attr("disabled", "true").html("<span class = 'spinner-border spinner-border-sm'></span>");
 			selection = 1;
 			db.collection("classes").doc(code).update({ selection: 1 }).then(function() {
 				$(".card-body *:not(h3, table)").remove();
 				$(".table").empty().append("<thead><th scope = 'col'>Student</th><th scope = 'col'>Character</th><th scope = 'col'>Partner</th></thead><tbody></tbody>");
 				db.collection("classes").doc(code).collection("students").orderBy("created", "asc").onSnapshot(function(qS) {
					$(".table tbody").empty();
					var empty = true;
					var chosen = qS.size;
					qS.forEach(function(s) {
						var student = s.data();
						if (student.character != -1 && student.status != 2) {
							empty = false;
							$("tbody").append("<tr><td>" + student.name + "</td><td style = 'color: rgb(" + colors[student.character] + ")'>" + unicorn.characters[student.character].name + "</td><td class = 'single'></td></tr>");
						} else if (student.status == 2) {
							chosen--;
							empty = false;
							$("tbody").append("<tr><td>" + student.name + "</td><td style = 'color: rgb(" + colors[student.character] + ")'>" + unicorn.characters[student.character].name + "</td><td>" + student.partner + "</td></tr>");
						}
					});
					if (empty) {
						all = false;
						$("tbody").append("<tr><td colspan = '3'>Students are selecting characters...</td></tr>");
					} else if (chosen == 0) {
						$(".card-body").append("<br><p><button class = 'btn btn-primary'>Proceed</button></p>");
						$(".card-body .btn-primary").click(function() {
							$(".card-body .btn-primary").attr("disabled", "true").html("<span class = 'spinner-border spinner-border-sm'></span>");
							selection = 2;
							db.collection("classes").doc(code).update({ selection: 2 }).then(function() {
								location.reload();
							});
						});
					} else if (chosen == 1) {
						$(".single").html("<button class = 'btn btn-sm btn-primary'>Create single team</button>");
						$(".single .btn-primary").click(function() {
							$(".single .btn-primary").attr("disabled", "true").html("<span class = 'spinner-border spinner-border-sm'></span>");
							db.collection("classes").doc(code).collection("students").doc($(this).parent().parent().children("td:first-child").html()).update({ status: 2, partner: false }).then(function() {
								db.collection("classes").doc(code).collection("teams").add({ members: [$(this).parent().children("td:first-child").html()] });
							});
						});
					}
				});
 			});
 		}
 		function createClass() {
 			$(".card .btn-primary").attr("disabled", "true").html("<span class = 'spinner-border spinner-border-sm'></span>");
 			db.collection("classes").doc(code).set({ teacher: "James Kwan", class: "Jumpstart Summer Program", school: "Jumpstart Academy", selection: 0 }).then(function() {
 				$(".card-body").html("<h3>Your class code: " + code + "</h3><p>Distribute this code to your students to let them join your class.</p><br><p class = 'd-flex align-items-center justify-content-center'><span class = 'spinner-border spinner-border-sm me-2'></span><span>Waiting for students to join...</span></p><table class = 'table w-75 mx-auto align-middle'></table>");
 				db.collection("classes").doc(code).collection("students").orderBy("created", "asc").onSnapshot(function(qS) {
 					if (selection == 0) {
	 					$("table").empty();
	 					size = qS.size;
	 					$("p.d-flex span:last-child").html(size == 0 ? "Waiting for students to join..." : size + (size == 1 ? " student " : " students ") + "joined...");
	 					qS.forEach(function(doc) {
	 						var student = doc.data();
	 						$("table").append("<tr><td class = 'w-50 py-1'>" + student.name + "</td><td class = 'w-50 py-1'><button class = 'btn btn-sm btn-danger' style = 'background-color: #dc3545'>Remove</button></td></tr>");
	 						$("tr:last-child .btn-danger").click(function() {
	 							$(this).attr("disabled", "true").html("<span class = 'spinner-border spinner-border-sm'></span>");
	 							db.collection("classes").doc(code).collection("students").doc(doc.id).delete();
	 						});
	 					});
	 					$("#beginSelection").remove();
	 					if (size > 0) {
	 						$(".card-body").append("<p class = 'mt-5' id = 'beginSelection'><button class = 'btn btn-primary' onclick = 'beginSelection()'>Continue to Character/Team Selection</button></p>");
	 					}
	 				}
 				});
 			});
 		}
		$.getJSON("../unicorn.json").always(function(data) {
			unicorn = data;
		});
	</script>
</body>
</html>